name: CI

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  test:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-20.04]
        python-version: ["3.10", "3.11"]
        include:
          # Additional Python versions on master branch only
          - os: ubuntu-20.04
            python-version: "3.8"
            master-only: true
          - os: ubuntu-20.04
            python-version: "3.12"
            master-only: true
          # macOS testing
          - os: macos-latest
            python-version: "3.10"
            master-only: true

    steps:
    - uses: actions/checkout@v4

    - name: Skip job if not on master branch (for master-only jobs)
      if: matrix.master-only && github.ref != 'refs/heads/master'
      run: |
        echo "Skipping job as it's master-only and we're not on master branch"
        exit 0

    - name: Setup Micromamba
      uses: mamba-org/setup-micromamba@v1
      with:
        micromamba-version: '1.5.8-0'  # Fixed version format
        environment-name: radis-env
        init-shell: >-
          bash
          powershell
        cache-environment: true
        post-cleanup: 'all'

    - name: Update Python version in environment.yml
      shell: bash
      run: |
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          sed -i -E 's/^- python$/- python=${{ matrix.python-version }}/' ./environment.yml
        else
          sed -i -E 's/^- python$/- python=${{ matrix.python-version }}/' ./environment.yml
        fi

    - name: Install xtensor (Linux/macOS)
      if: runner.os != 'Windows'
      shell: bash -el {0}  # Use -el for proper conda activation
      run: |
        micromamba install xtensor -c conda-forge -y

    - name: Copy requirements.txt to temp folder
      shell: bash
      run: |
        mkdir -p /tmp
        cp requirements.txt /tmp/requirements.txt

    - name: Create conda environment
      shell: bash -el {0}
      run: |
        micromamba create -f ./environment.yml -y

    - name: Activate environment and install test dependencies
      shell: bash -el {0}
      run: |
        micromamba activate radis-env
        micromamba list
        pip install pytest-cov pytest-random-order
        pip install -e . -v

    - name: Setup display for headless testing (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb

    - name: Set matplotlib backend
      shell: bash -el {0}
      run: |
        echo "MPLBACKEND=Agg" >> $GITHUB_ENV

    - name: Check Python version and environment
      shell: bash -el {0}
      run: |
        micromamba activate radis-env
        python --version
        which python
        pip list | grep radis

    - name: Run fast tests
      shell: bash -el {0}
      run: |
        micromamba activate radis-env
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          xvfb-run -a pytest -m "fast and not needs_db_CDSD_HITEMP_PCN and not needs_db_CDSD_HITEMP and not needs_db_CDSD_HITEMP_PC" --durations=10 --random-order --tb=short
        else
          pytest -m "fast and not needs_db_CDSD_HITEMP_PCN and not needs_db_CDSD_HITEMP and not needs_db_CDSD_HITEMP_PC" --durations=10 --random-order --tb=short
        fi

    - name: Run long tests
      shell: bash -el {0}
      run: |
        micromamba activate radis-env
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          xvfb-run -a pytest -m "not fast and not needs_cuda and not download_large_databases and not needs_db_CDSD_HITEMP and not needs_db_CDSD_HITEMP_PCN and not needs_db_CDSD_HITEMP_PC and not needs_db_HITEMP_CO2_DUNHAM and not needs_db_HITEMP_CO_DUNHAM" --durations=10 --tb=short
        elif [[ "$RUNNER_OS" == "macOS" ]]; then
          # Skip long tests on macOS for now (as per Travis config)
          echo "Skipping long tests on macOS"
        else
          pytest -m "not fast and not needs_cuda and not download_large_databases and not needs_db_CDSD_HITEMP and not needs_db_CDSD_HITEMP_PCN and not needs_db_CDSD_HITEMP_PC and not needs_db_HITEMP_CO2_DUNHAM and not needs_db_HITEMP_CO_DUNHAM" --durations=10 --tb=short
        fi

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-20.04' && matrix.python-version == '3.10'
      shell: bash -el {0}
      run: |
        micromamba activate radis-env
        pip install codecov
        codecov
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
